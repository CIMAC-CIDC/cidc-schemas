{
  "$schema": "metaschema/strict_meta_schema.json#",
  "$id": "mif",
  "title": "mIF Assay",
  "description": "Multiplex immunofluorescence.",
  "type": "object",
  "inheritableBase": true,

  "allOf": [
    { "$ref": "assays/components/assay_core.json" },
    { "$ref": "assays/components/image.json" },
    { "$ref": "assays/components/imaging_data.json" }
  ],
  "required": ["records", "panel", "antibodies"],
  "properties": {
    "assay_creator": { "$ref": "assays/components/assay_core.json#properties/assay_creator" },
    "slide_scanner_model": { "$ref": "assays/components/image.json#properties/slide_scanner_model" },
    "image_analysis_software": { "$ref": "assays/components/image.json#properties/image_analysis_software" },
    "image_analysis_software_version": { "$ref": "assays/components/image.json#properties/image_analysis_software_version" },
    "cell_segmentation_model": { "$ref": "assays/components/image.json#properties/cell_segmentation_model" },
    "positive_cell_detection": { "$ref": "assays/components/image.json#properties/positive_cell_detection" },
    "staining": { "$ref": "assays/components/imaging_data.json#properties/staining" },
    "staining_date": { "$ref": "assays/components/imaging_data.json#properties/staining_date" },
    "imaging_date": { "$ref": "assays/components/imaging_data.json#properties/imaging_date" },
    "imaging_status": { "$ref": "assays/components/imaging_data.json#properties/imaging_status" },

    "panel": {
        "type": "string",
        "enum": [
            "Panel 1: PD-L1, CD68, PD-1, CD8, CD3, pan-cytokeratin, DAPI",
            "Panel 2: FOXP3, Granzyme B, CD45RO, CD8, CD3, pan-cytokeratin, DAPI",
            "Panel 3: pan-cytokeratin, CD8, PD-1, PD-L1, DAPI",
            "Panel 4: SOX10, CD8, PD-1, PD-L1, DAPI"
        ]
    },

    "antibodies": {
      "type": "array",
      "mergeStrategy": "arrayMergeById",
      "mergeOptions": { "idRef": "antibody" },
      "items": {
        "description": "Data specific to antibody preparation on the multiplex immunofluorescence platform.",
        "type": "object",
        "allOf": [
          { "$ref": "assays/components/antibody.json" }
        ],
        "required": [
          "fluor_wavelength",
          "primary_ab_dilution",
          "dilutent",
          "fluor_dilution",
          "antigen_retrieval_time",
          "primary_incubation_time",
          "amplification_time"
        ],
        "additionalProperties": false,
        "properties": {
          "antibody": { "$ref": "assays/components/antibody.json#properties/antibody" },
          "clone": { "$ref": "assays/components/antibody.json#properties/clone" },
          "company": { "$ref": "assays/components/antibody.json#properties/company" },
          "cat_num": { "$ref": "assays/components/antibody.json#properties/cat_num" },
          "lot_num": { "$ref": "assays/components/antibody.json#properties/lot_num" },

          "export_name": {
            "description": "Name of this antibody in InForm export, e.g. 'CD8 (Opal 520)'",
            "type": "string"
          },
          "staining_order": {
            "description": "Order of staining applied",
            "type": "integer"
          },
          "fluor_wavelength": {
            "description": "Wavelength registered for Alexa Fluor processing.",
            "type": "integer"
          },
          "primary_ab_dilution": {
            "description": "Concentration ratio for primary antibody dilution.",
            "type": "string"
          },
          "dilutent": {
            "description": "Dilution agent used for antibody sample.",
            "type": "string"
          },
          "fluor_dilution":{
            "description": "Concentration ratio for fluor dilution agent.",
            "type": "string"
          },
          "antigen_retrieval_time": {
            "description": "Length of time needed for antigen retrieval.",
            "type": "string",
            "format": "time"
          },
          "primary_incubation_time": {
            "description": "Length of time for primary antibody incubation.",
            "type": "string",
            "format": "time"
          },
          "amplification_time": {
            "description": "Length of time required for amplified signal detection.",
            "type": "string",
            "format": "time"
          }
        }
      }
    },

    "records": {
      "type": "array",
      "description": "A single data record from mIF assay.",
      "mergeStrategy": "arrayMergeById",
      "mergeOptions": { "idRef": "cimac_id" },

      "items": {
        "description": "A single data record from mIF assay.",
        "type": "object",
        "inheritableBase": true,
        "mergeStrategy": "objectMerge",

        "required": ["cimac_id", "files"],
        "properties": {
          "cimac_id": {
            "$comment": "Id of an sample within this clinical trial, that this assay record is based upon.",
            "$ref": "sample.json#properties/cimac_id"
          },
          "files": {
            "description": "mIF assay input files.",
            "type": "object",
            "inheritableBase": true,
            "mergeStrategy": "objectMerge",

            "required": ["regions_of_interest"],
            "properties": {
              "whole_slide_imaging_file": {
                "$comment": "Digital slide produced from the scanning of conventional glass slides.",
                "$ref": "artifacts/artifact_image.json"
              },
              "roi_annotations": {
                "$comment": "Text describing region of interest for experiment.",
                "$ref": "artifacts/artifact_text.json"
              },
              "mif_output_summary": {
                "$comment": "Summary of the results of the experiment.",
                "$ref": "artifacts/artifact_csv.json"
              },
              "regions_of_interest": {
                "type": "array",
                "mergeStrategy": "arrayMergeById",
                "mergeOptions": { "idRef": "roi_id" },
                "items": {

                  "description": "A region of interest (ROI) is a portion of an image which has been analyzed using image processing software.",
                  "type": "object",
                  "additionalProperties": false,
                  "mergeStrategy": "objectMerge",

                  "allOf": [
                    { "$ref": "assays/components/composite_image.json" }
                  ],
                  "required": [
                    "roi_id",
                    "im3",
                    "exports"
                  ],
                  "properties": {
                    "roi_id": {
                      "description": "Identifier of a region of interest within one mIF slide, e.g. 1, 2, 3 or [123 x 321]",
                      "type": "string"
                    },
                    "im3": { "$ref": "assays/components/composite_image.json#properties/im3" },
                    "component_data":{ "$ref": "assays/components/composite_image.json#properties/component_data" },
                    "composite_image":{ "$ref": "assays/components/composite_image.json#properties/composite_image" },
                    "exports": {
                      "type": "array",
                      "mergeStrategy": "arrayMergeById",
                      "mergeOptions": { "idRef": "export_id" },
                      "items": {
                        "description": "An analysis export from inForm of a region of interest (ROI).",
                        "type": "object",
                        "additionalProperties": false,
                        "mergeStrategy": "objectMerge",

                        "allOf": [
                          { "$ref": "assays/components/mapping.json" }
                        ],
                        "required": [
                          "export_id",
                          "cell_seg_data",
                          "cell_seg_data_summary"
                        ],
                        "properties": {
                          "export_id": {
                            "description": "Name used for an inForm export of a region of interest within one mIF slide, e.g. CD8, CD45RO",
                            "type": "string"
                          },
                          "cell_seg_data": { "$ref": "assays/components/mapping.json#properties/cell_seg_data" },
                          "cell_seg_data_summary": { "$ref": "assays/components/mapping.json#properties/cell_seg_data_summary" },
                          "phenotype_map": { "$ref": "assays/components/mapping.json#properties/phenotype_map" },
                          "score_data": { "$ref": "assays/components/mapping.json#properties/score_data" },
                          "tissue_seg_data": { "$ref": "assays/components/mapping.json#properties/tissue_seg_data" },
                          "tissue_seg_data_summary": { "$ref": "assays/components/mapping.json#properties/tissue_seg_data_summary" },
                          "binary_seg_maps": { "$ref": "assays/components/mapping.json#properties/binary_seg_maps" },

                          "image_with_all_seg": { "$ref": "assays/components/mapping.json#properties/seg_maps" },
                          "image_with_cell_seg_map": { "$ref": "assays/components/mapping.json#properties/seg_maps" },
                          "image_with_phenotype_map": { "$ref": "assays/components/mapping.json#properties/phenotype_map" },
                          "image_with_tissue_seg": { "$ref": "assays/components/mapping.json#properties/seg_maps" }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}