{
    "$schema": "metaschema/strict_meta_schema.json#",
    "$id": "cytof",
    "title": "CYTOF Run",
    "description": "Base information about the acquisition and analysis CyTOF data.",
    "type": "object",
    "additionalProperties": false,
    "mergeStrategy": "objectMerge",
    
    "allOf": [
        {"$ref": "assays/components/assay_core.json"}
    ],
    "required": [
        "cytof_antibodies",
        "records",
        "assay_run_id"
    ],
    "properties": {
        "assay_creator": {"$ref": "assays/components/assay_core.json#properties/assay_creator"},
        "assay_run_id": {
            "type": "string",
            "description": "User defined unique identifier for this assay run."
        },
        "cytof_antibodies": {
            "description": "Data specific to antibody preparation on the CyTOF assay.",
            "type": "array",
            "mergeStrategy": "append",

            "items": {
                "title": "CyTOF Conjugated Antibody",
                "description": "Data specific to antibody preparation on the CyTOF assay.",
                "type": "object",
                "additionalProperties": false,
                "mergeStrategy": "arrayMergeById",
                "mergeOptions": {
                    "idRef": "antibody"
                },

                "allOf": [{ "$ref": "assays/components/antibody.json" }],
                "required": ["isotope", "dilution", "stain_type", "usage"],
                "properties": {
                    "antibody": {"$ref": "assays/components/antibody.json#properties/antibody"},
                    "clone": {"$ref": "assays/components/antibody.json#properties/clone"},
                    "company": {"$ref": "assays/components/antibody.json#properties/company"},
                    "cat_num": {"$ref": "assays/components/antibody.json#properties/cat_num"},
                    "lot_num": {"$ref": "assays/components/antibody.json#properties/lot_num"},

                    "isotope": {
                      "description": "Antibody isotype used to help differentiate antibody signals.",
                      "type": "string"
                    },
                    "dilution": {
                      "description": "Concentration ratio of dilution buffer for primary antibody.",
                      "type": "string"
                    },
                    "stain_type": {
                      "description": "Type of staining method used for antibody.",
                      "type": "string",
                      "enum": ["Surface Stain", "Intracellular"]
                    },
                    "usage": {
                        "description": "How this antibody should be used in automatic analysis",
                        "type": "string",
                        "enum": ["Ignored", "Used", "Analysis Only"]
                      }
                  }
                }
        },
        "instrument": {
            "description": "Name of CyTOF instrument on which experiment was conducted.",
            "type": "string"
        },
        "panel_name": {
            "description": "Standardized CyTOF panel name used for antibody sample development.",
            "type": "string"
        },
        "spike_in_fcs": {
            "$ref": "artifacts/artifact_fcs.json"
        },
        "source_fcs": {
            "type": "array",
            "items": {
                "$ref": "artifacts/artifact_fcs.json"
            }
        },
        "batch_id": {
            "description": "CyTOF batch identification number.",
            "type": "string"
        },
        "astrolabe_reports": {
            "$ref": "artifacts/artifact_zip.json"
        },
        "astrolabe_analysis": {
            "$ref": "artifacts/artifact_zip.json"
        },
        "records": {
            "type": "array",
            "description": "A single data record from CyTOF assay batch.",
            "mergeStrategy": "arrayMergeById",
            "mergeOptions": {
              "idRef": "cimac_id"
            },
            "items": {
                "description": "A single data record from CyTOF assay batch.",
                "type": "object",
                "additionalProperties": true,
                "mergeStrategy": "objectMerge",

                "required": [
                    "cimac_id",
                    "input_files"
                ],
                "properties": {
                    "cimac_id": {
                        "$comment": "Id of a sample within this clinical trial, that this assay record is based upon.",
                        "$ref": "sample.json#properties/cimac_id"
                    },
                    "date_of_acquisition": {
                        "description": "Date of CyTOF batch acquisition.",
                        "type": "string"
                    },
                    "injector": {
                        "description": "Name of Injector component used as part of the CyTOF software",
                        "type": "string"
                    },
                    "acquisition_buffer": {
                        "description": "Cell staining buffer used for antibody and cell dilution.",
                        "type": "string"
                    },
                    "average_event_per_second": {
                        "description": "Analysis rate of CyTOF expressions per second.",
                        "type": "number"
                    },
                    "run_time": {
                        "description": "Length of run time for CyTOF experiment.",
                        "type": "string"
                    },
                    "notes": {
                        "description": "Any notes pertaining to CyTOF acquisition.",
                        "type": "string"
                    },
                    "concatenation_version": {
                        "description": "Concatenation of FCS files into a single FCS version number.",
                        "type": "string"
                    },
                    "normalization_version": {
                        "description": "Version of normalization for CyTOF assay batch.",
                        "type": "string"
                    },
                    "beads_removed": {
                        "description": "Confirmation of beads being removed after normalization process.",
                        "type": "string",
                        "enum": [
                            "Y",
                            "N"
                        ]
                    },
                    "staining_date": {
                        "description": "Date of staining for CyTOF assay slides.",
                        "type": "string",
                        "format": "date"
                    },
                    "debarcoding_protocol": {
                        "description": "The strategy/kit used to barcode CyTOF samples.",
                        "type": "string"
                    },
                    "debarcoding_key": {
                        "description": "An ID that maps to the specific isotope labeling scheme in the debarcoding protocol.",
                        "type": "string"
                    },
                    "preprocessing_notes": {
                        "description": "Any notes pertaining to preprocessing of CyTOF data.",
                        "type": "string"
                    },
                    "input_files": {
                        "description": "CyTOF Assay Input Files",
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "processed_fcs": {
                                "$ref": "artifacts/artifact_fcs.json"
                            },
                            "normalized_and_debarcoded_fcs": {
                                "$ref": "artifacts/artifact_fcs.json"
                            }
                        }
                    },
                    "output_files": {
                        "description": "Output files generated from the CyTOF assay: FCS file with enumerations for compartment, assignment and profiling cell labels; 3 CSV keys for mapping from respective enumeration indices to the cell labels; 3 CSV files providing cell count information for each of the cell labels",
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "fcs_file": {
                                "$ref": "artifacts/artifact_fcs.json"
                            },
                            "assignment": {
                                "$ref": "artifacts/artifact_csv.json"
                            },
                            "compartment": {
                                "$ref": "artifacts/artifact_csv.json"
                            },
                            "profiling": {
                                "$ref": "artifacts/artifact_csv.json"
                            },
                            "cell_counts_assignment": {
                                "$ref": "artifacts/artifact_csv.json"
                            },
                            "cell_counts_compartment": {
                                "$ref": "artifacts/artifact_csv.json"
                            },
                            "cell_counts_profiling": {
                                "$ref": "artifacts/artifact_csv.json"
                            }
                        }
                    }
                }
            }
        }
    }
}

